"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi */

/**
 * Worker object for checking connection to licensing and repository server.
 *
 * @module PbxExtensionModules
 */
var PingLicenseServerWorker = {
  /**
   * Stores in session the last connection status
   * @type {string}
   */
  cacheKey: 'InternetConnectionStatus',

  /**
   * jQuery object for the div with information if no internet.
   * @type {jQuery}
   */
  $noInternet: $('div.show-if-no-internet'),

  /**
   * Class name that should be disabled if no internet connection.
   * @type {string}
   */
  disableIfNoInternetClass: '.disable-if-no-internet',

  /**
   * Time in milliseconds before fetching new check internet request.
   * @type {number}
   */
  timeOut: 86400,

  /**
   * The id of the timer function for the worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**
   * Initializes the worker.
   */
  initialize: function initialize() {
    PingLicenseServerWorker.changeTabsAvailability();
    PingLicenseServerWorker.restartWorker();
  },

  /**
   * Restarts the worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(PingLicenseServerWorker.timeoutHandle);
    PingLicenseServerWorker.worker();
  },

  /**
   * Worker function for checking the internet connection on a background.
   */
  worker: function worker() {
    var isConnected = sessionStorage.getItem(PingLicenseServerWorker.cacheKey);

    if (isConnected === 'false') {
      PbxApi.LicensePing(PingLicenseServerWorker.cbAfterResponse);
    }
  },

  /**
   * Callback function after receiving a response from the server.
   * @param isConnected - connection result.
   */
  cbAfterResponse: function cbAfterResponse(isConnected) {
    if (isConnected === true) {
      // The internet is available
      sessionStorage.setItem(PingLicenseServerWorker.cacheKey, 'true');
    } else {
      // The internet is not available
      sessionStorage.setItem(PingLicenseServerWorker.cacheKey, 'false');
    }

    PingLicenseServerWorker.changeTabsAvailability();
    PingLicenseServerWorker.timeoutHandle = window.setTimeout(PingLicenseServerWorker.worker, PingLicenseServerWorker.timeOut);
  },

  /**
   * Change the availability of tabs based on the internet connection status.
   */
  changeTabsAvailability: function changeTabsAvailability() {
    var isConnected = sessionStorage.getItem(PingLicenseServerWorker.cacheKey);

    if (isConnected === 'false') {
      // The internet is not available
      PingLicenseServerWorker.$noInternet.show();
      $(PingLicenseServerWorker.disableIfNoInternetClass).addClass('disabled');
    } else {
      // The internet is available
      PingLicenseServerWorker.$noInternet.hide();
      $(PingLicenseServerWorker.disableIfNoInternetClass).removeClass('disabled');
    }
  }
}; // When the document is ready, initialize the internet connection worker

$(document).ready(function () {
  PingLicenseServerWorker.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLXBpbmctbGljLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJQaW5nTGljZW5zZVNlcnZlcldvcmtlciIsImNhY2hlS2V5IiwiJG5vSW50ZXJuZXQiLCIkIiwiZGlzYWJsZUlmTm9JbnRlcm5ldENsYXNzIiwidGltZU91dCIsInRpbWVPdXRIYW5kbGUiLCJpbml0aWFsaXplIiwiY2hhbmdlVGFic0F2YWlsYWJpbGl0eSIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwiaXNDb25uZWN0ZWQiLCJzZXNzaW9uU3RvcmFnZSIsImdldEl0ZW0iLCJQYnhBcGkiLCJMaWNlbnNlUGluZyIsImNiQWZ0ZXJSZXNwb25zZSIsInNldEl0ZW0iLCJzZXRUaW1lb3V0Iiwic2hvdyIsImFkZENsYXNzIiwiaGlkZSIsInJlbW92ZUNsYXNzIiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSx1QkFBdUIsR0FBRztBQUU1QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxRQUFRLEVBQUMsMEJBTm1COztBQVE1QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxXQUFXLEVBQUVDLENBQUMsQ0FBQyx5QkFBRCxDQVpjOztBQWM1QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSx3QkFBd0IsRUFBRyx5QkFsQkM7O0FBb0I1QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxPQUFPLEVBQUUsS0F4Qm1COztBQTBCNUI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsYUFBYSxFQUFFLENBOUJhOztBQWdDNUI7QUFDSjtBQUNBO0FBQ0lDLEVBQUFBLFVBbkM0Qix3QkFtQ2Y7QUFDVFAsSUFBQUEsdUJBQXVCLENBQUNRLHNCQUF4QjtBQUNBUixJQUFBQSx1QkFBdUIsQ0FBQ1MsYUFBeEI7QUFDSCxHQXRDMkI7O0FBd0M1QjtBQUNKO0FBQ0E7QUFDSUEsRUFBQUEsYUEzQzRCLDJCQTJDWjtBQUNaQyxJQUFBQSxNQUFNLENBQUNDLFlBQVAsQ0FBb0JYLHVCQUF1QixDQUFDWSxhQUE1QztBQUNBWixJQUFBQSx1QkFBdUIsQ0FBQ2EsTUFBeEI7QUFDSCxHQTlDMkI7O0FBZ0Q1QjtBQUNKO0FBQ0E7QUFDSUEsRUFBQUEsTUFuRDRCLG9CQW1EbkI7QUFDTCxRQUFNQyxXQUFXLEdBQUdDLGNBQWMsQ0FBQ0MsT0FBZixDQUF1QmhCLHVCQUF1QixDQUFDQyxRQUEvQyxDQUFwQjs7QUFDQSxRQUFJYSxXQUFXLEtBQUssT0FBcEIsRUFBNkI7QUFDekJHLE1BQUFBLE1BQU0sQ0FBQ0MsV0FBUCxDQUFtQmxCLHVCQUF1QixDQUFDbUIsZUFBM0M7QUFDSDtBQUNKLEdBeEQyQjs7QUEwRDVCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lBLEVBQUFBLGVBOUQ0QiwyQkE4RFpMLFdBOURZLEVBOERDO0FBQ3pCLFFBQUlBLFdBQVcsS0FBSyxJQUFwQixFQUEwQjtBQUN0QjtBQUNBQyxNQUFBQSxjQUFjLENBQUNLLE9BQWYsQ0FBdUJwQix1QkFBdUIsQ0FBQ0MsUUFBL0MsRUFBeUQsTUFBekQ7QUFDSCxLQUhELE1BR087QUFDSDtBQUNBYyxNQUFBQSxjQUFjLENBQUNLLE9BQWYsQ0FBdUJwQix1QkFBdUIsQ0FBQ0MsUUFBL0MsRUFBeUQsT0FBekQ7QUFDSDs7QUFDREQsSUFBQUEsdUJBQXVCLENBQUNRLHNCQUF4QjtBQUNBUixJQUFBQSx1QkFBdUIsQ0FBQ1ksYUFBeEIsR0FBd0NGLE1BQU0sQ0FBQ1csVUFBUCxDQUNwQ3JCLHVCQUF1QixDQUFDYSxNQURZLEVBRXBDYix1QkFBdUIsQ0FBQ0ssT0FGWSxDQUF4QztBQUlILEdBM0UyQjs7QUE2RTVCO0FBQ0o7QUFDQTtBQUNJRyxFQUFBQSxzQkFoRjRCLG9DQWlGNUI7QUFDSSxRQUFNTSxXQUFXLEdBQUdDLGNBQWMsQ0FBQ0MsT0FBZixDQUF1QmhCLHVCQUF1QixDQUFDQyxRQUEvQyxDQUFwQjs7QUFFQSxRQUFJYSxXQUFXLEtBQUssT0FBcEIsRUFBNkI7QUFDekI7QUFDQWQsTUFBQUEsdUJBQXVCLENBQUNFLFdBQXhCLENBQW9Db0IsSUFBcEM7QUFDQW5CLE1BQUFBLENBQUMsQ0FBQ0gsdUJBQXVCLENBQUNJLHdCQUF6QixDQUFELENBQW9EbUIsUUFBcEQsQ0FBNkQsVUFBN0Q7QUFDSCxLQUpELE1BSU87QUFDSDtBQUNBdkIsTUFBQUEsdUJBQXVCLENBQUNFLFdBQXhCLENBQW9Dc0IsSUFBcEM7QUFDQXJCLE1BQUFBLENBQUMsQ0FBQ0gsdUJBQXVCLENBQUNJLHdCQUF6QixDQUFELENBQW9EcUIsV0FBcEQsQ0FBZ0UsVUFBaEU7QUFDSDtBQUNKO0FBN0YyQixDQUFoQyxDLENBZ0dBOztBQUNBdEIsQ0FBQyxDQUFDdUIsUUFBRCxDQUFELENBQVlDLEtBQVosQ0FBa0IsWUFBTTtBQUNwQjNCLEVBQUFBLHVCQUF1QixDQUFDTyxVQUF4QjtBQUNILENBRkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCwgUGJ4QXBpICovXG5cbi8qKlxuICogV29ya2VyIG9iamVjdCBmb3IgY2hlY2tpbmcgY29ubmVjdGlvbiB0byBsaWNlbnNpbmcgYW5kIHJlcG9zaXRvcnkgc2VydmVyLlxuICpcbiAqIEBtb2R1bGUgUGJ4RXh0ZW5zaW9uTW9kdWxlc1xuICovXG5jb25zdCBQaW5nTGljZW5zZVNlcnZlcldvcmtlciA9IHtcblxuICAgIC8qKlxuICAgICAqIFN0b3JlcyBpbiBzZXNzaW9uIHRoZSBsYXN0IGNvbm5lY3Rpb24gc3RhdHVzXG4gICAgICogQHR5cGUge3N0cmluZ31cbiAgICAgKi9cbiAgICBjYWNoZUtleTonSW50ZXJuZXRDb25uZWN0aW9uU3RhdHVzJyxcblxuICAgIC8qKlxuICAgICAqIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBkaXYgd2l0aCBpbmZvcm1hdGlvbiBpZiBubyBpbnRlcm5ldC5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRub0ludGVybmV0OiAkKCdkaXYuc2hvdy1pZi1uby1pbnRlcm5ldCcpLFxuXG4gICAgLyoqXG4gICAgICogQ2xhc3MgbmFtZSB0aGF0IHNob3VsZCBiZSBkaXNhYmxlZCBpZiBubyBpbnRlcm5ldCBjb25uZWN0aW9uLlxuICAgICAqIEB0eXBlIHtzdHJpbmd9XG4gICAgICovXG4gICAgZGlzYWJsZUlmTm9JbnRlcm5ldENsYXNzOiAgJy5kaXNhYmxlLWlmLW5vLWludGVybmV0JyxcblxuICAgIC8qKlxuICAgICAqIFRpbWUgaW4gbWlsbGlzZWNvbmRzIGJlZm9yZSBmZXRjaGluZyBuZXcgY2hlY2sgaW50ZXJuZXQgcmVxdWVzdC5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXQ6IDg2NDAwLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGlkIG9mIHRoZSB0aW1lciBmdW5jdGlvbiBmb3IgdGhlIHdvcmtlci5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXRIYW5kbGU6IDAsXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgd29ya2VyLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIFBpbmdMaWNlbnNlU2VydmVyV29ya2VyLmNoYW5nZVRhYnNBdmFpbGFiaWxpdHkoKTtcbiAgICAgICAgUGluZ0xpY2Vuc2VTZXJ2ZXJXb3JrZXIucmVzdGFydFdvcmtlcigpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZXN0YXJ0cyB0aGUgd29ya2VyLlxuICAgICAqL1xuICAgIHJlc3RhcnRXb3JrZXIoKSB7XG4gICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoUGluZ0xpY2Vuc2VTZXJ2ZXJXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIFBpbmdMaWNlbnNlU2VydmVyV29ya2VyLndvcmtlcigpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBXb3JrZXIgZnVuY3Rpb24gZm9yIGNoZWNraW5nIHRoZSBpbnRlcm5ldCBjb25uZWN0aW9uIG9uIGEgYmFja2dyb3VuZC5cbiAgICAgKi9cbiAgICB3b3JrZXIoKSB7XG4gICAgICAgIGNvbnN0IGlzQ29ubmVjdGVkID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShQaW5nTGljZW5zZVNlcnZlcldvcmtlci5jYWNoZUtleSk7XG4gICAgICAgIGlmIChpc0Nvbm5lY3RlZCA9PT0gJ2ZhbHNlJykge1xuICAgICAgICAgICAgUGJ4QXBpLkxpY2Vuc2VQaW5nKFBpbmdMaWNlbnNlU2VydmVyV29ya2VyLmNiQWZ0ZXJSZXNwb25zZSk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gYWZ0ZXIgcmVjZWl2aW5nIGEgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyLlxuICAgICAqIEBwYXJhbSBpc0Nvbm5lY3RlZCAtIGNvbm5lY3Rpb24gcmVzdWx0LlxuICAgICAqL1xuICAgIGNiQWZ0ZXJSZXNwb25zZShpc0Nvbm5lY3RlZCkge1xuICAgICAgICBpZiAoaXNDb25uZWN0ZWQgPT09IHRydWUpIHtcbiAgICAgICAgICAgIC8vIFRoZSBpbnRlcm5ldCBpcyBhdmFpbGFibGVcbiAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oUGluZ0xpY2Vuc2VTZXJ2ZXJXb3JrZXIuY2FjaGVLZXksICd0cnVlJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBUaGUgaW50ZXJuZXQgaXMgbm90IGF2YWlsYWJsZVxuICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShQaW5nTGljZW5zZVNlcnZlcldvcmtlci5jYWNoZUtleSwgJ2ZhbHNlJyk7XG4gICAgICAgIH1cbiAgICAgICAgUGluZ0xpY2Vuc2VTZXJ2ZXJXb3JrZXIuY2hhbmdlVGFic0F2YWlsYWJpbGl0eSgpO1xuICAgICAgICBQaW5nTGljZW5zZVNlcnZlcldvcmtlci50aW1lb3V0SGFuZGxlID0gd2luZG93LnNldFRpbWVvdXQoXG4gICAgICAgICAgICBQaW5nTGljZW5zZVNlcnZlcldvcmtlci53b3JrZXIsXG4gICAgICAgICAgICBQaW5nTGljZW5zZVNlcnZlcldvcmtlci50aW1lT3V0LFxuICAgICAgICApO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDaGFuZ2UgdGhlIGF2YWlsYWJpbGl0eSBvZiB0YWJzIGJhc2VkIG9uIHRoZSBpbnRlcm5ldCBjb25uZWN0aW9uIHN0YXR1cy5cbiAgICAgKi9cbiAgICBjaGFuZ2VUYWJzQXZhaWxhYmlsaXR5KClcbiAgICB7XG4gICAgICAgIGNvbnN0IGlzQ29ubmVjdGVkID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShQaW5nTGljZW5zZVNlcnZlcldvcmtlci5jYWNoZUtleSk7XG5cbiAgICAgICAgaWYgKGlzQ29ubmVjdGVkID09PSAnZmFsc2UnKSB7XG4gICAgICAgICAgICAvLyBUaGUgaW50ZXJuZXQgaXMgbm90IGF2YWlsYWJsZVxuICAgICAgICAgICAgUGluZ0xpY2Vuc2VTZXJ2ZXJXb3JrZXIuJG5vSW50ZXJuZXQuc2hvdygpO1xuICAgICAgICAgICAgJChQaW5nTGljZW5zZVNlcnZlcldvcmtlci5kaXNhYmxlSWZOb0ludGVybmV0Q2xhc3MpLmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gVGhlIGludGVybmV0IGlzIGF2YWlsYWJsZVxuICAgICAgICAgICAgUGluZ0xpY2Vuc2VTZXJ2ZXJXb3JrZXIuJG5vSW50ZXJuZXQuaGlkZSgpO1xuICAgICAgICAgICAgJChQaW5nTGljZW5zZVNlcnZlcldvcmtlci5kaXNhYmxlSWZOb0ludGVybmV0Q2xhc3MpLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICB9XG4gICAgfVxufTtcblxuLy8gV2hlbiB0aGUgZG9jdW1lbnQgaXMgcmVhZHksIGluaXRpYWxpemUgdGhlIGludGVybmV0IGNvbm5lY3Rpb24gd29ya2VyXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICAgUGluZ0xpY2Vuc2VTZXJ2ZXJXb3JrZXIuaW5pdGlhbGl6ZSgpO1xufSk7XG4iXX0=