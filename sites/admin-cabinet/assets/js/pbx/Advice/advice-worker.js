"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, globalWebAdminLanguage, sessionStorage, $, globalTranslate */

/**
 * Advice Worker module.
 * @module adviceWorker
 */
var adviceWorker = {
  /**
   * Time in milliseconds before fetching new advice.
   * @type {number}
   */
  timeOut: 10000,

  /**
   * The id of the timer function for advice worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**
   * jQuery element for advice container.
   * @type {jQuery}
   */
  $advice: $('#advice'),

  /**
   * jQuery element for advice bell button.
   * @type {jQuery}
   */
  $adviceBellButton: $('#show-advice-button'),

  /**
   * Initializes the advice worker.
   */
  initialize: function initialize() {
    adviceWorker.showPreviousAdvice(); // Let's initiate the retrieval of new advice.

    adviceWorker.restartWorker();
    window.addEventListener('ConfigDataChanged', adviceWorker.cbOnDataChanged);
  },

  /**
   * Restarts the advice worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(adviceWorker.timeoutHandle);
    adviceWorker.worker();
  },

  /**
   * Event handler for language or data change.
   */
  cbOnDataChanged: function cbOnDataChanged() {
    sessionStorage.removeItem("previousAdvice".concat(globalWebAdminLanguage));
    sessionStorage.removeItem("previousAdviceBell".concat(globalWebAdminLanguage));
    setTimeout(adviceWorker.restartWorker, 3000);
  },

  /**
   * Shows old advice until receiving an update from the station.
   */
  showPreviousAdvice: function showPreviousAdvice() {
    var previousAdviceBell = sessionStorage.getItem("previousAdviceBell".concat(globalWebAdminLanguage));

    if (previousAdviceBell) {
      adviceWorker.$adviceBellButton.html(previousAdviceBell);
    }

    var previousAdvice = sessionStorage.getItem("previousAdvice".concat(globalWebAdminLanguage));

    if (previousAdvice) {
      adviceWorker.$advice.html(previousAdvice);
      adviceWorker.$adviceBellButton.popup({
        position: 'bottom left',
        popup: adviceWorker.$advice,
        delay: {
          show: 300,
          hide: 10000
        },
        on: 'click',
        movePopup: false
      });
    }
  },

  /**
   * Worker function for fetching advice.
   */
  worker: function worker() {
    PbxApi.AdviceGetList(adviceWorker.cbAfterResponse);
  },

  /**
   * Callback function after receiving the response.
   * @param {object} response - Response object from the API.
   */
  cbAfterResponse: function cbAfterResponse(response) {
    if (response === false) {
      return;
    }

    adviceWorker.$advice.html('');

    if (response.advice !== undefined) {
      var htmlMessages = '';
      var countMessages = 0;
      var iconBellClass = '';
      htmlMessages += "<div class=\"ui header\">".concat(globalTranslate.adv_PopupHeader, "</div>");
      htmlMessages += '<div class="ui relaxed divided list">';

      if (response.advice.needUpdate !== undefined && response.advice.needUpdate.length > 0) {
        $(window).trigger('SecurityWarning', [response.advice]);
      }

      if (response.advice.error !== undefined && response.advice.error.length > 0) {
        $.each(response.advice.error, function (key, value) {
          htmlMessages += '<div class="item">';
          htmlMessages += '<i class="frown outline red icon"></i>';
          htmlMessages += "".concat(value);
          htmlMessages += '</div>';
          countMessages += 1;
        });
      }

      if (response.advice.warning !== undefined && response.advice.warning.length > 0) {
        $.each(response.advice.warning, function (key, value) {
          htmlMessages += '<div class="item yellow">';
          htmlMessages += '<i class="meh outline yellow icon"></i>';
          htmlMessages += "".concat(value);
          htmlMessages += '</div>';
          countMessages += 1;
        });
      }

      if (response.advice.info !== undefined && response.advice.info.length > 0) {
        $.each(response.advice.info, function (key, value) {
          htmlMessages += '<div class="item">';
          htmlMessages += '<i class="smile outline blue icon"></i>';
          htmlMessages += "".concat(value);
          htmlMessages += '</div>';
          countMessages += 1;
        });
      }

      if (response.advice.error !== undefined && response.advice.error.length > 0) {
        iconBellClass = 'red icon bell';
      } else if (response.advice.warning !== undefined && response.advice.warning.length > 0) {
        iconBellClass = 'yellow icon bell';
      } else if (response.advice.info !== undefined && response.advice.info.length > 0) {
        iconBellClass = 'blue icon bell';
      }

      htmlMessages += '</div>';
      adviceWorker.$advice.html(htmlMessages);
      sessionStorage.setItem("previousAdvice".concat(globalWebAdminLanguage), htmlMessages);

      if (countMessages > 0) {
        adviceWorker.$adviceBellButton.html("<i class=\"".concat(iconBellClass, "\"></i>").concat(countMessages)).popup({
          position: 'bottom left',
          popup: adviceWorker.$advice,
          delay: {
            show: 300,
            hide: 10000
          },
          on: 'click',
          movePopup: false
        });
        adviceWorker.$adviceBellButton.find('i').transition('set looping').transition('pulse', '1000ms');
      } else {
        adviceWorker.$adviceBellButton.html("<i class=\"grey icon bell\"></i>");
      }

      sessionStorage.setItem("previousAdviceBell".concat(globalWebAdminLanguage), adviceWorker.$adviceBellButton.html());
      adviceWorker.timeoutHandle = window.setTimeout(adviceWorker.worker, adviceWorker.timeOut);
    } else if (response.success === true && response.advice !== undefined && response.advice.length === 0) {
      sessionStorage.removeItem("previousAdvice".concat(globalWebAdminLanguage));
      sessionStorage.removeItem("previousAdviceBell".concat(globalWebAdminLanguage));
      adviceWorker.$adviceBellButton.html('<i class="grey icon bell outline"></i>');
    }
  }
};
/**
 *  Initialize advice worker on document ready
 */

$(document).ready(function () {
  adviceWorker.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9BZHZpY2UvYWR2aWNlLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJhZHZpY2VXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsIiRhZHZpY2UiLCIkIiwiJGFkdmljZUJlbGxCdXR0b24iLCJpbml0aWFsaXplIiwic2hvd1ByZXZpb3VzQWR2aWNlIiwicmVzdGFydFdvcmtlciIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJjYk9uRGF0YUNoYW5nZWQiLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwic2Vzc2lvblN0b3JhZ2UiLCJyZW1vdmVJdGVtIiwiZ2xvYmFsV2ViQWRtaW5MYW5ndWFnZSIsInNldFRpbWVvdXQiLCJwcmV2aW91c0FkdmljZUJlbGwiLCJnZXRJdGVtIiwiaHRtbCIsInByZXZpb3VzQWR2aWNlIiwicG9wdXAiLCJwb3NpdGlvbiIsImRlbGF5Iiwic2hvdyIsImhpZGUiLCJvbiIsIm1vdmVQb3B1cCIsIlBieEFwaSIsIkFkdmljZUdldExpc3QiLCJjYkFmdGVyUmVzcG9uc2UiLCJyZXNwb25zZSIsImFkdmljZSIsInVuZGVmaW5lZCIsImh0bWxNZXNzYWdlcyIsImNvdW50TWVzc2FnZXMiLCJpY29uQmVsbENsYXNzIiwiZ2xvYmFsVHJhbnNsYXRlIiwiYWR2X1BvcHVwSGVhZGVyIiwibmVlZFVwZGF0ZSIsImxlbmd0aCIsInRyaWdnZXIiLCJlcnJvciIsImVhY2giLCJrZXkiLCJ2YWx1ZSIsIndhcm5pbmciLCJpbmZvIiwic2V0SXRlbSIsImZpbmQiLCJ0cmFuc2l0aW9uIiwic3VjY2VzcyIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLFlBQVks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QUN6QmxCLFlBQVksQ0FBQ2MsTUFEWSxFQUV6QmQsWUFBWSxDQUFDQyxPQUZZLENBQTdCO0FBSUgsS0FuRkQsTUFtRk8sSUFBSWdDLFFBQVEsQ0FBQ29CLE9BQVQsS0FBcUIsSUFBckIsSUFDSnBCLFFBQVEsQ0FBQ0MsTUFBVCxLQUFvQkMsU0FEaEIsSUFFSkYsUUFBUSxDQUFDQyxNQUFULENBQWdCUSxNQUFoQixLQUEyQixDQUYzQixFQUU4QjtBQUNqQzNCLE1BQUFBLGNBQWMsQ0FBQ0MsVUFBZix5QkFBMkNDLHNCQUEzQztBQUNBRixNQUFBQSxjQUFjLENBQUNDLFVBQWYsNkJBQStDQyxzQkFBL0M7QUFDQWpCLE1BQUFBLFlBQVksQ0FBQ0ssaUJBQWIsQ0FDS2dCLElBREwsQ0FDVSx3Q0FEVjtBQUVIO0FBQ0o7QUF6TGdCLENBQXJCO0FBNExBO0FBQ0E7QUFDQTs7QUFDQWpCLENBQUMsQ0FBQ2tELFFBQUQsQ0FBRCxDQUFZQyxLQUFaLENBQWtCLFlBQU07QUFDcEJ2RCxFQUFBQSxZQUFZLENBQUNNLFVBQWI7QUFDSCxDQUZEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCDCqSAyMDE3LTIwMjMgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIGdsb2JhbFJvb3RVcmwsIGdsb2JhbFdlYkFkbWluTGFuZ3VhZ2UsIHNlc3Npb25TdG9yYWdlLCAkLCBnbG9iYWxUcmFuc2xhdGUgKi9cblxuLyoqXG4gKiBBZHZpY2UgV29ya2VyIG1vZHVsZS5cbiAqIEBtb2R1bGUgYWR2aWNlV29ya2VyXG4gKi9cbmNvbnN0IGFkdmljZVdvcmtlciA9IHtcblxuICAgIC8qKlxuICAgICAqIFRpbWUgaW4gbWlsbGlzZWNvbmRzIGJlZm9yZSBmZXRjaGluZyBuZXcgYWR2aWNlLlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgdGltZU91dDogMTAwMDAsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgaWQgb2YgdGhlIHRpbWVyIGZ1bmN0aW9uIGZvciBhZHZpY2Ugd29ya2VyLlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgdGltZU91dEhhbmRsZTogMCxcblxuICAgIC8qKlxuICAgICAqIGpRdWVyeSBlbGVtZW50IGZvciBhZHZpY2UgY29udGFpbmVyLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJGFkdmljZTogJCgnI2FkdmljZScpLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IGVsZW1lbnQgZm9yIGFkdmljZSBiZWxsIGJ1dHRvbi5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRhZHZpY2VCZWxsQnV0dG9uOiAkKCcjc2hvdy1hZHZpY2UtYnV0dG9uJyksXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgYWR2aWNlIHdvcmtlci5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplKCkge1xuICAgICAgICBhZHZpY2VXb3JrZXIuc2hvd1ByZXZpb3VzQWR2aWNlKCk7XG5cbiAgICAgICAgLy8gTGV0J3MgaW5pdGlhdGUgdGhlIHJldHJpZXZhbCBvZiBuZXcgYWR2aWNlLlxuICAgICAgICBhZHZpY2VXb3JrZXIucmVzdGFydFdvcmtlcigpO1xuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignQ29uZmlnRGF0YUNoYW5nZWQnLCBhZHZpY2VXb3JrZXIuY2JPbkRhdGFDaGFuZ2VkKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUmVzdGFydHMgdGhlIGFkdmljZSB3b3JrZXIuXG4gICAgICovXG4gICAgcmVzdGFydFdvcmtlcigpIHtcbiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChhZHZpY2VXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIGFkdmljZVdvcmtlci53b3JrZXIoKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRXZlbnQgaGFuZGxlciBmb3IgbGFuZ3VhZ2Ugb3IgZGF0YSBjaGFuZ2UuXG4gICAgICovXG4gICAgY2JPbkRhdGFDaGFuZ2VkKCkge1xuICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKGBwcmV2aW91c0FkdmljZSR7Z2xvYmFsV2ViQWRtaW5MYW5ndWFnZX1gKTtcbiAgICAgICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbShgcHJldmlvdXNBZHZpY2VCZWxsJHtnbG9iYWxXZWJBZG1pbkxhbmd1YWdlfWApO1xuICAgICAgICBzZXRUaW1lb3V0KGFkdmljZVdvcmtlci5yZXN0YXJ0V29ya2VyLCAzMDAwKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogU2hvd3Mgb2xkIGFkdmljZSB1bnRpbCByZWNlaXZpbmcgYW4gdXBkYXRlIGZyb20gdGhlIHN0YXRpb24uXG4gICAgICovXG4gICAgc2hvd1ByZXZpb3VzQWR2aWNlKCkge1xuICAgICAgICBjb25zdCBwcmV2aW91c0FkdmljZUJlbGwgPSBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGBwcmV2aW91c0FkdmljZUJlbGwke2dsb2JhbFdlYkFkbWluTGFuZ3VhZ2V9YCk7XG4gICAgICAgIGlmIChwcmV2aW91c0FkdmljZUJlbGwpIHtcbiAgICAgICAgICAgIGFkdmljZVdvcmtlci4kYWR2aWNlQmVsbEJ1dHRvbi5odG1sKHByZXZpb3VzQWR2aWNlQmVsbCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcHJldmlvdXNBZHZpY2UgPSBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGBwcmV2aW91c0FkdmljZSR7Z2xvYmFsV2ViQWRtaW5MYW5ndWFnZX1gKTtcbiAgICAgICAgaWYgKHByZXZpb3VzQWR2aWNlKSB7XG4gICAgICAgICAgICBhZHZpY2VXb3JrZXIuJGFkdmljZS5odG1sKHByZXZpb3VzQWR2aWNlKTtcbiAgICAgICAgICAgIGFkdmljZVdvcmtlci4kYWR2aWNlQmVsbEJ1dHRvbi5wb3B1cCh7XG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnYm90dG9tIGxlZnQnLFxuICAgICAgICAgICAgICAgICAgICBwb3B1cDogYWR2aWNlV29ya2VyLiRhZHZpY2UsXG4gICAgICAgICAgICAgICAgICAgIGRlbGF5OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzaG93OiAzMDAsXG4gICAgICAgICAgICAgICAgICAgICAgICBoaWRlOiAxMDAwMCxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgb246ICdjbGljaycsXG4gICAgICAgICAgICAgICAgICAgIG1vdmVQb3B1cDogZmFsc2UsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogV29ya2VyIGZ1bmN0aW9uIGZvciBmZXRjaGluZyBhZHZpY2UuXG4gICAgICovXG4gICAgd29ya2VyKCkge1xuICAgICAgICBQYnhBcGkuQWR2aWNlR2V0TGlzdChhZHZpY2VXb3JrZXIuY2JBZnRlclJlc3BvbnNlKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gYWZ0ZXIgcmVjZWl2aW5nIHRoZSByZXNwb25zZS5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVzcG9uc2UgLSBSZXNwb25zZSBvYmplY3QgZnJvbSB0aGUgQVBJLlxuICAgICAqL1xuICAgIGNiQWZ0ZXJSZXNwb25zZShyZXNwb25zZSkge1xuICAgICAgICBpZiAocmVzcG9uc2UgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgYWR2aWNlV29ya2VyLiRhZHZpY2UuaHRtbCgnJyk7XG4gICAgICAgIGlmIChyZXNwb25zZS5hZHZpY2UgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgbGV0IGh0bWxNZXNzYWdlcyA9ICcnO1xuICAgICAgICAgICAgbGV0IGNvdW50TWVzc2FnZXMgPSAwO1xuICAgICAgICAgICAgbGV0IGljb25CZWxsQ2xhc3MgPSAnJztcbiAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSBgPGRpdiBjbGFzcz1cInVpIGhlYWRlclwiPiR7Z2xvYmFsVHJhbnNsYXRlLmFkdl9Qb3B1cEhlYWRlcn08L2Rpdj5gO1xuICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9ICc8ZGl2IGNsYXNzPVwidWkgcmVsYXhlZCBkaXZpZGVkIGxpc3RcIj4nO1xuXG4gICAgICAgICAgICBpZiAocmVzcG9uc2UuYWR2aWNlLm5lZWRVcGRhdGUgIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICYmIHJlc3BvbnNlLmFkdmljZS5uZWVkVXBkYXRlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAkKHdpbmRvdykudHJpZ2dlcignU2VjdXJpdHlXYXJuaW5nJywgW3Jlc3BvbnNlLmFkdmljZV0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocmVzcG9uc2UuYWR2aWNlLmVycm9yICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAmJiByZXNwb25zZS5hZHZpY2UuZXJyb3IubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICQuZWFjaChyZXNwb25zZS5hZHZpY2UuZXJyb3IsIChrZXksIHZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSAnPGRpdiBjbGFzcz1cIml0ZW1cIj4nO1xuICAgICAgICAgICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gJzxpIGNsYXNzPVwiZnJvd24gb3V0bGluZSByZWQgaWNvblwiPjwvaT4nO1xuICAgICAgICAgICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gYCR7dmFsdWV9YDtcbiAgICAgICAgICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9ICc8L2Rpdj4nO1xuICAgICAgICAgICAgICAgICAgICBjb3VudE1lc3NhZ2VzICs9IDE7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocmVzcG9uc2UuYWR2aWNlLndhcm5pbmcgIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICYmIHJlc3BvbnNlLmFkdmljZS53YXJuaW5nLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAkLmVhY2gocmVzcG9uc2UuYWR2aWNlLndhcm5pbmcsIChrZXksIHZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSAnPGRpdiBjbGFzcz1cIml0ZW0geWVsbG93XCI+JztcbiAgICAgICAgICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9ICc8aSBjbGFzcz1cIm1laCBvdXRsaW5lIHllbGxvdyBpY29uXCI+PC9pPic7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSBgJHt2YWx1ZX1gO1xuICAgICAgICAgICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gJzwvZGl2Pic7XG4gICAgICAgICAgICAgICAgICAgIGNvdW50TWVzc2FnZXMgKz0gMTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5hZHZpY2UuaW5mbyAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgJiYgcmVzcG9uc2UuYWR2aWNlLmluZm8ubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICQuZWFjaChyZXNwb25zZS5hZHZpY2UuaW5mbywgKGtleSwgdmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9ICc8ZGl2IGNsYXNzPVwiaXRlbVwiPic7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSAnPGkgY2xhc3M9XCJzbWlsZSBvdXRsaW5lIGJsdWUgaWNvblwiPjwvaT4nO1xuICAgICAgICAgICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gYCR7dmFsdWV9YDtcbiAgICAgICAgICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9ICc8L2Rpdj4nO1xuICAgICAgICAgICAgICAgICAgICBjb3VudE1lc3NhZ2VzICs9IDE7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5hZHZpY2UuZXJyb3IgIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICYmIHJlc3BvbnNlLmFkdmljZS5lcnJvci5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgaWNvbkJlbGxDbGFzcyA9ICdyZWQgaWNvbiBiZWxsJztcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuYWR2aWNlLndhcm5pbmcgIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICYmIHJlc3BvbnNlLmFkdmljZS53YXJuaW5nLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBpY29uQmVsbENsYXNzID0gJ3llbGxvdyBpY29uIGJlbGwnO1xuXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmFkdmljZS5pbmZvICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAmJiByZXNwb25zZS5hZHZpY2UuaW5mby5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgaWNvbkJlbGxDbGFzcyA9ICdibHVlIGljb24gYmVsbCc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gJzwvZGl2Pic7XG4gICAgICAgICAgICBhZHZpY2VXb3JrZXIuJGFkdmljZS5odG1sKGh0bWxNZXNzYWdlcyk7XG4gICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGBwcmV2aW91c0FkdmljZSR7Z2xvYmFsV2ViQWRtaW5MYW5ndWFnZX1gLCBodG1sTWVzc2FnZXMpO1xuXG4gICAgICAgICAgICBpZiAoY291bnRNZXNzYWdlcyA+IDApIHtcbiAgICAgICAgICAgICAgICBhZHZpY2VXb3JrZXIuJGFkdmljZUJlbGxCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgLmh0bWwoYDxpIGNsYXNzPVwiJHtpY29uQmVsbENsYXNzfVwiPjwvaT4ke2NvdW50TWVzc2FnZXN9YClcbiAgICAgICAgICAgICAgICAgICAgLnBvcHVwKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnYm90dG9tIGxlZnQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgcG9wdXA6IGFkdmljZVdvcmtlci4kYWR2aWNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGVsYXk6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93OiAzMDAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlkZTogMTAwMDAsXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgb246ICdjbGljaycsXG4gICAgICAgICAgICAgICAgICAgICAgICBtb3ZlUG9wdXA6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBhZHZpY2VXb3JrZXIuJGFkdmljZUJlbGxCdXR0b24uZmluZCgnaScpXG4gICAgICAgICAgICAgICAgICAgIC50cmFuc2l0aW9uKCdzZXQgbG9vcGluZycpXG4gICAgICAgICAgICAgICAgICAgIC50cmFuc2l0aW9uKCdwdWxzZScsICcxMDAwbXMnKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYWR2aWNlV29ya2VyLiRhZHZpY2VCZWxsQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgIC5odG1sKGA8aSBjbGFzcz1cImdyZXkgaWNvbiBiZWxsXCI+PC9pPmApXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGBwcmV2aW91c0FkdmljZUJlbGwke2dsb2JhbFdlYkFkbWluTGFuZ3VhZ2V9YCwgYWR2aWNlV29ya2VyLiRhZHZpY2VCZWxsQnV0dG9uLmh0bWwoKSk7XG4gICAgICAgICAgICBhZHZpY2VXb3JrZXIudGltZW91dEhhbmRsZSA9IHdpbmRvdy5zZXRUaW1lb3V0KFxuICAgICAgICAgICAgICAgIGFkdmljZVdvcmtlci53b3JrZXIsXG4gICAgICAgICAgICAgICAgYWR2aWNlV29ya2VyLnRpbWVPdXQsXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN1Y2Nlc3MgPT09IHRydWVcbiAgICAgICAgICAgICYmIHJlc3BvbnNlLmFkdmljZSAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAmJiByZXNwb25zZS5hZHZpY2UubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKGBwcmV2aW91c0FkdmljZSR7Z2xvYmFsV2ViQWRtaW5MYW5ndWFnZX1gKTtcbiAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oYHByZXZpb3VzQWR2aWNlQmVsbCR7Z2xvYmFsV2ViQWRtaW5MYW5ndWFnZX1gKTtcbiAgICAgICAgICAgIGFkdmljZVdvcmtlci4kYWR2aWNlQmVsbEJ1dHRvblxuICAgICAgICAgICAgICAgIC5odG1sKCc8aSBjbGFzcz1cImdyZXkgaWNvbiBiZWxsIG91dGxpbmVcIj48L2k+Jyk7XG4gICAgICAgIH1cbiAgICB9LFxufTtcblxuLyoqXG4gKiAgSW5pdGlhbGl6ZSBhZHZpY2Ugd29ya2VyIG9uIGRvY3VtZW50IHJlYWR5XG4gKi9cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcbiAgICBhZHZpY2VXb3JrZXIuaW5pdGlhbGl6ZSgpO1xufSk7XG4iXX0=